name: Build Wheels

on: [push] # TODO

jobs:
  build_wheels:
    name: Build wheels on ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        # macos-13 is an intel runner, macos-14 is apple silicon
        # windows-2019 is used for 32-bit, windows-latest for 64-bit
        os: [ubuntu-latest, windows-2019, windows-latest, macos-13, macos-14]

    steps:
        # TODO replace build from source with grabbing release binaries
      - name: Checkout parent repository
        uses: actions/checkout@v4
        with:
          repository: NTIA/p2108
          ref: AddPythonWrapper # Todo remove

      - name: Clone required submodules
        uses: pietrobolcato/action-clone-private-submodule@main
        with:
          ssh_private_key: ${{ secrets.SSH_PRIVATE_KEY }}
          module_link: NTIA/p2108-python
          module_path: wrap/python
        
      - name: Install CMake # (latest stable version)
        uses: lukka/get-cmake@latest
    
      - name: "CMake: Build (32-bit)"
        if: matrix.os == 'windows-2019'
        uses: lukka/run-cmake@v10
        with:
          configurePreset: release32
          configurePresetAdditionalArgs: "['-DBUILD_DOCS=OFF', '-DRUN_TESTS=OFF']"
          buildPreset: release32
    
      - name: "CMake: Build (64-bit)"
        if: matrix.os != 'windows-2019'
        uses: lukka/run-cmake@v10
        with:
          configurePreset: release64
          configurePresetAdditionalArgs: "['-DBUILD_DOCS=OFF', '-DRUN_TESTS=OFF']"
          buildPreset: release64
        
      - name: Change to Python wrapper directory
        run: cd wrap/python

      - name: Install cibuildwheel
        run: python -m pip install cibuildwheel==2.19.2
        working-directory: wrap/python

      - name: List files in subdir (DEBUG)
        run: ls
        working-directory: wrap/python

      - name: Build wheels
        run: python -m cibuildwheel --output-dir wheelhouse
        working-directory: wrap/python

      - uses: actions/upload-artifact@v4
        with:
          name: cibw-wheels-${{ matrix.os }}-${{ strategy.job-index }}
          path: ./wrap/python/wheelhouse/*.whl